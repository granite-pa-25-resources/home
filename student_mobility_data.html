<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Area 5 Student Mobility & Population Data | Granite School District</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.plot.ly/plotly-2.26.0.min.js"></script>

    <style>
        :root {
            --bg-primary: #0f1419;
            --bg-secondary: #1a1f2e;
            --bg-tertiary: #252b3b;
            --text-primary: #e8eaed;
            --text-secondary: #9ca3af;
            --border-color: #374151;
            --accent-cyan: #06b6d4;
            --accent-green: #10b981;
            --accent-red: #ef4444;
            --accent-yellow: #fbbf24;
            --accent-purple: #8b5cf6;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
        }

        header {
            background: linear-gradient(135deg, #1a1f2e 0%, #252b3b 100%);
            padding: 2rem 1rem;
            text-align: center;
            border-bottom: 3px solid var(--accent-cyan);
            box-shadow: var(--shadow);
        }

        header h1 {
            color: var(--accent-cyan);
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        header p {
            color: var(--text-secondary);
            font-size: 1.1rem;
        }

        .back-link {
            display: inline-block;
            margin: 1rem;
            padding: 0.5rem 1rem;
            background: var(--bg-tertiary);
            color: var(--accent-cyan);
            text-decoration: none;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .back-link:hover {
            background: var(--accent-cyan);
            color: var(--bg-primary);
            transform: translateY(-2px);
        }

        .school-section {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 2rem;
            margin: 2rem 0;
            box-shadow: var(--shadow);
            border-left: 4px solid var(--accent-cyan);
        }

        .school-section h2 {
            color: var(--accent-cyan);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .school-color-badge {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: inline-block;
            border: 2px solid var(--border-color);
        }

        .chart-container {
            background: var(--bg-tertiary);
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
        }

        .chart-title {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 1rem;
            color: var(--text-primary);
        }

        .pdf-link {
            display: inline-block;
            margin: 1rem 0;
            padding: 0.75rem 1.5rem;
            background: var(--accent-purple);
            color: white;
            text-decoration: none;
            border-radius: 8px;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .pdf-link:hover {
            background: #7c3aed;
            transform: scale(1.05);
            color: white;
        }

        .pdf-link::before {
            content: "📄 ";
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin: 1.5rem 0;
        }

        .stat-card {
            background: var(--bg-primary);
            padding: 1rem;
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }

        .stat-value {
            color: var(--accent-cyan);
            font-size: 1.8rem;
            font-weight: bold;
        }

        .alert {
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
        }

        .alert-info {
            background: rgba(6, 182, 212, 0.1);
            border: 1px solid var(--accent-cyan);
            color: var(--text-primary);
        }

        .alert-warning {
            background: rgba(251, 191, 36, 0.1);
            border: 1px solid var(--accent-yellow);
            color: var(--text-primary);
        }

        footer {
            background: var(--bg-secondary);
            padding: 2rem;
            text-align: center;
            margin-top: 3rem;
            border-top: 2px solid var(--border-color);
            color: var(--text-secondary);
        }

        footer a {
            color: var(--accent-cyan);
            text-decoration: none;
        }

        footer a:hover {
            text-decoration: underline;
        }

        @media (max-width: 768px) {
            header h1 {
                font-size: 1.5rem;
            }

            header p {
                font-size: 0.95rem;
            }

            .school-section {
                padding: 1rem;
                margin: 1rem 0;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .chart-title {
                font-size: 1rem;
            }

            .alert h3, .alert h4 {
                font-size: 1.1rem;
            }

            .alert ul {
                padding-left: 1.25rem;
                font-size: 0.9rem;
            }

            .pdf-link {
                font-size: 0.9rem;
                padding: 0.6rem 1rem;
            }
        }

        @media (max-width: 576px) {
            header h1 {
                font-size: 1.2rem;
            }

            .back-link {
                font-size: 0.85rem;
                padding: 0.4rem 0.8rem;
            }

            .stat-value {
                font-size: 1.4rem;
            }

            .chart-container {
                padding: 1rem;
            }
        }

        /* Navigation Components */
        .nav-toggle {
            position: fixed;
            top: 0.5rem;
            left: 0.5rem;
            z-index: 1000;
            background: var(--bg-tertiary);
            border: none;
            border-radius: 8px;
            padding: 0.5rem 0.75rem;
            cursor: pointer;
            box-shadow: var(--shadow);
            transition: all 0.3s ease;
            -webkit-tap-highlight-color: transparent;
        }

        .nav-toggle:hover {
            background: var(--accent-cyan);
            transform: scale(1.05);
        }

        .nav-toggle span {
            display: block;
            width: 25px;
            height: 3px;
            background: white;
            margin: 5px 0;
            transition: 0.3s;
            border-radius: 2px;
        }

        .nav-toggle.active span:nth-child(1) {
            transform: rotate(-45deg) translate(-5px, 6px);
        }

        .nav-toggle.active span:nth-child(2) {
            opacity: 0;
        }

        .nav-toggle.active span:nth-child(3) {
            transform: rotate(45deg) translate(-5px, -6px);
        }

        .nav-sidebar {
            position: fixed;
            top: 0;
            left: -320px;
            width: 320px;
            height: 100vh;
            background: var(--bg-secondary);
            border-right: 2px solid var(--border-color);
            overflow-y: auto;
            transition: left 0.3s ease;
            z-index: 999;
            padding: 80px 20px 20px;
            box-shadow: 4px 0 10px rgba(0, 0, 0, 0.5);
        }

        .nav-sidebar.active {
            left: 0;
        }

        .nav-sidebar h3 {
            color: var(--accent-cyan);
            margin-bottom: 20px;
            font-size: 1.2em;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .nav-sidebar ul {
            list-style: none;
        }

        .nav-sidebar li {
            margin: 8px 0;
        }

        .nav-sidebar a {
            color: var(--text-secondary);
            text-decoration: none;
            display: block;
            padding: 10px 15px;
            border-radius: 6px;
            transition: all 0.2s ease;
            font-size: 0.95em;
        }

        .nav-sidebar a:hover {
            background: var(--bg-tertiary);
            color: var(--accent-cyan);
            padding-left: 20px;
        }

        .nav-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            z-index: 998;
        }

        .nav-overlay.active {
            display: block;
        }
    </style>
</head>
<body>
    <!-- Navigation Toggle -->
    <button class="nav-toggle" id="navToggle" aria-label="Toggle navigation">
        <span></span>
        <span></span>
        <span></span>
    </button>

    <!-- Navigation Sidebar -->
    <nav class="nav-sidebar" id="navSidebar">
        <h3>Pages</h3>
        <ul style="border-bottom: 2px solid var(--border-color); padding-bottom: 15px; margin-bottom: 15px;">
            <li><a href="index.html">📊 Main Analysis</a></li>
            <li><a href="student_mobility_data.html" style="color: var(--accent-cyan); font-weight: bold;">🔄 Student Mobility Data</a></li>
            <li><a href="population_trends.html">📈 Population Trends</a></li>
        </ul>
        <h3>Quick Links</h3>
        <ul>
            <li><a href="#comprehensive-sankey">Complete Flow Map</a></li>
            <li><a href="#enrollment-chart">Enrollment Comparison</a></li>
        </ul>
    </nav>

    <!-- Overlay for mobile -->
    <div class="nav-overlay" id="navOverlay"></div>

    <header>
        <h1>📊 Area 5 Student Mobility & Population Data</h1>
        <p>Interactive Visualizations of Enrollment Patterns Across 10 Elementary Schools</p>
        <p style="font-size: 0.9em; margin-top: 0.5rem;">Data as of October 1, 2025 | Granite School District</p>
    </header>

    <div class="container-fluid px-2 px-sm-3 px-md-4">
        <div class="row">
            <div class="col-12 col-xl-11 mx-auto">

                <div class="alert alert-info mt-3 mt-md-4">
                    <h3>About These Data</h3>
                    <p><strong>Student Mobility Tables</strong> show where students live (boundary school) versus where they actually attend school. This reveals:</p>
                    <ul>
                        <li><strong>In-boundary enrollment:</strong> Students living in the school's boundary who attend that school</li>
                        <li><strong>Out-of-boundary enrollment:</strong> Students from other boundaries choosing to attend this school</li>
                        <li><strong>Boundary residents attending elsewhere:</strong> Students who live in this boundary but choose other schools</li>
                    </ul>
                    <p style="margin-top: 1rem;"><strong>Why this matters:</strong> Schools with high out-of-boundary enrollment are in demand. The district's population study focuses on declining in-boundary populations but doesn't fully account for choice-based enrollment patterns.</p>
                </div>

                <div class="alert alert-success mt-3" style="color:#DDD; background: rgba(16, 185, 129, 0.1); border: 1px solid var(--accent-green);">
                    <h3 class="mb-3">✅ Complete Official Data from District PDFs</h3>
                    <p><strong>All 10 schools now display actual data</strong> from the official Granite School District Student Mobility Tables (October 1, 2025).</p>
                    <p>Each Sankey diagram shows the top 5-15 boundary sources feeding into each school, with exact student counts. Click the "View Official Student Mobility PDF" link under each school to verify the data.</p>
                    <p class="mt-3 mb-2"><strong>Key Insights:</strong></p>
                    <ul class="mb-0">
                        <li><strong>Penn (51% out-of-boundary)</strong> and <strong>Morningside (66% out-of-boundary)</strong> draw heavily from across the district</li>
                        <li><strong>Crestview (92% in-boundary)</strong> serves primarily its own neighborhood</li>
                        <li><strong>Eastwood (47% out-of-boundary)</strong> is recommended for closure despite drawing nearly half its students from other boundaries</li>
                    </ul>
                </div>

                <!-- Comprehensive Flow Diagram -->
                <div class="school-section" style="background: linear-gradient(135deg, #1a1f2e 0%, #252b3b 100%); border-left: 4px solid var(--accent-purple);">
                    <h2 style="color: var(--accent-purple);" id="comprehensive-sankey" class="mb-3">🔀 Complete Student Mobility Flow Map</h2>
                    <p class="text-secondary mb-3" style="line-height: 1.6;">
                        This comprehensive diagram shows all student flows for Area 5 schools.
                        <strong>Left side:</strong> Student sources (10 Area 5 boundaries, Other Boundaries, and Out of District).
                        <strong>Right side:</strong> Student destinations (10 Area 5 schools and Other Schools).
                    </p>
                    <div class="chart-container">
                        <div class="row g-3 mb-3 align-items-center">
                            <div class="col-12 col-md-7 col-lg-8">
                                <div class="chart-title" style="margin: 0;">Complete Student Flow Matrix: Every Source → Every Destination</div>
                            </div>
                            <div class="col-12 col-md-5 col-lg-4">
                                <div style="background: var(--bg-primary); padding: 0.75rem 1.25rem; border-radius: 8px; border: 2px solid var(--accent-cyan); text-align: center;">
                                    <div style="color: var(--text-secondary); font-size: 0.85rem; margin-bottom: 0.25rem;">Total Area 5 Enrollment</div>
                                    <div style="color: var(--accent-cyan); font-size: 1.5rem; font-weight: bold;" id="totalEnrollmentDisplay">Loading...</div>
                                </div>
                            </div>
                        </div>
                        <div id="comprehensiveSankeyChart" class="w-100" style="min-height: 600px;"></div>
                        <p class="small text-secondary mt-3 mb-2" style="line-height: 1.6;">
                            <em>💡 <span class="d-none d-md-inline">Hover over</span><span class="d-md-none">Tap on</span> flows to see student counts and percentages. Each flow shows what percentage of the source's total students that pathway represents. 
                            For example: "Oakridge Boundary → Oakridge Elementary: 168 students (78.5% of source total)" means 168 out of 214 Oakridge boundary residents attend Oakridge Elementary.</em>
                        </p>
                        <p style="color: var(--text-secondary); font-size: 0.85em; margin-top: 0.5rem; font-style: italic;">
                            <strong>Note on Data:</strong> This comprehensive view merges data from all 10 school mobility tables. Minor discrepancies (typically 5-10 students per school) may occur due to how different tables categorize small flows, rounding, or timing differences. Official enrollment totals shown in the bar chart below are authoritative.
                        </p>
                    </div>
                    <div class="alert alert-info">
                        <h3 class="mb-3">📊 How to Read This Diagram</h3>
                        <div class="row g-3 mb-3">
                            <div class="col-12 col-lg-6">
                                <strong style="color: var(--accent-cyan);">Left Side - Where Students Live:</strong>
                                <ul class="mt-2 mb-0">
                                    <li><strong>10 Colored Nodes:</strong> Area 5 school boundaries (Cottonwood, Crestview, Driggs, Eastwood, Morningside, Oakridge, Oakwood, Penn, Rosecrest, Upland Terrace)</li>
                                    <li><strong>Other Boundaries (gray):</strong> Other Granite School District boundaries (Lincoln, Wilson, Moss, Woodstock, etc.) - consolidated</li>
                                    <li><strong>Out of District (gray):</strong> Students living outside Granite School District</li>
                                </ul>
                            </div>
                            <div class="col-12 col-lg-6">
                                <strong style="color: var(--accent-cyan);">Right Side - Where Students Attend:</strong>
                                <ul class="mt-2 mb-0">
                                    <li><strong>10 Colored Nodes:</strong> Area 5 elementary schools receiving students</li>
                                    <li><strong>Other Schools (gray):</strong> All non-Area 5 destinations (Alternative 3-A, Woodstock, other GSD schools) - consolidated</li>
                                    <li><strong>Flow Thickness:</strong> Proportional to number of students in that pathway</li>
                                </ul>
                            </div>
                        </div>
                        <p class="mb-0" style="color: var(--text-secondary);"><strong>Color Coding:</strong> Thick same-color flows = students staying in their home boundary school. Lighter cross-flows = students choosing different schools. Gray flows = external sources/destinations.</p>
                    </div>

                    <div class="alert alert-warning">
                        <h3 class="mb-3 mb-md-4">🔍 Deep Dive: Key Insights from the Data</h3>
                        
                        <h4 class="mt-3 mt-md-4" style="color: var(--accent-yellow);">1. School Choice is Highly Active in Area 5</h4>
                        <ul>
                            <li><strong>Morningside:</strong> Only 193 of 567 students (34%) are from its own boundary. <strong>374 students (66%)</strong> come from outside, including 68 from Out of District, 43 from Upland Terrace, and 39 from Driggs.</li>
                            <li><strong>Penn:</strong> Only 290 of 586 students (49%) are from its boundary. <strong>296 students (51%)</strong> come from elsewhere, with major flows from Other Boundaries and Out of District (53).</li>
                            <li><strong>Eastwood (closure target):</strong> 124 of 233 students (53%) are boundary residents, but <strong>109 students (47%)</strong> chose to attend from other boundaries - demonstrating significant demand despite closure recommendation.</li>
                        </ul>

                        <h4 class="mt-3 mt-md-4" style="color: var(--accent-yellow);">2. Cross-District Flows are Substantial</h4>
                        <ul>
                            <li><strong>Other Boundaries</strong> (Lincoln, Wilson, Moss, Woodstock, etc.) send substantial numbers to Area 5 schools: Over 100 students to Penn, significant flows to Morningside, Upland Terrace, and multiple other Area 5 schools.</li>
                            <li><strong>Out of District students</strong> contribute materially to enrollment: 79 at Oakwood, 68 at Morningside, 53 at Penn, 43 at Cottonwood, plus more at other schools.</li>
                            <li><strong>Total external contribution:</strong> Hundreds of students from non-Area 5 sources attend Area 5 schools, complicating any "declining population" narrative.</li>
                            <li><strong>Visible in diagram:</strong> The "Other Boundaries" and "Out of District" nodes show these critical external flows that sustain Area 5 enrollment.</li>
                        </ul>

                        <h4 class="mt-3 mt-md-4" style="color: var(--accent-yellow);">3. Retention Rates Vary Dramatically</h4>
                        <ul>
                            <li><strong>Crestview:</strong> Highest retention at 80% (424 of 528 boundary residents stay). Only 104 leave, mostly to other Area 5 schools or Other Schools.</li>
                            <li><strong>Oakwood:</strong> 71% retention (333 of 472 stay). Loses 43 to Cottonwood and 42 to Other Schools (Woodstock).</li>
                            <li><strong>Upland Terrace:</strong> 80% retention (304 of 382 stay). Loses 43 to Morningside and smaller numbers to other schools.</li>
                            <li><strong>Morningside:</strong> Only 66% retention (193 of 293 stay). Loses 100 students, primarily to Driggs (38), Eastwood (19), and Upland Terrace (15).</li>
                        </ul>

                        <h4 class="mt-3 mt-md-4" style="color: var(--accent-yellow);">4. Area 5 Students Choose Schools Outside the Area</h4>
                        <ul>
                            <li><strong>Other Schools</strong> (consolidated) includes Alternative 3-A, Woodstock Elementary, and other GSD schools outside Area 5.</li>
                            <li><strong>Key outflows:</strong> Oakwood boundary sends ~50 students to other schools, Crestview sends ~20, Driggs ~20, and other boundaries have smaller outflows.</li>
                            <li><strong>Total pattern:</strong> While most Area 5 residents stay within Area 5, dozens choose alternative programs or schools in adjacent areas.</li>
                            <li><strong>Visible in diagram:</strong> The "Other Schools" node on the right shows all Area 5 residents leaving the area for other educational options.</li>
                        </ul>

                        <h4 class="mt-3 mt-md-4" style="color: var(--accent-yellow);">5. Critical Implications for PAC Recommendations</h4>
                        <ul>
                            <li><strong>Closing Eastwood:</strong> District assumes 233 students transfer to Oakridge, but 109 (47%) are choice students who may leave the district instead of transferring.</li>
                            <li><strong>Morningside Magnet Conversion:</strong> Converting to DLI/ALC affects only ~75 traditional boundary students (not 193), as most boundary students already attend DLI/ALC programs.</li>
                            <li><strong>Capacity Planning:</strong> Current utilization calculations don't account for choice-driven enrollment patterns. Schools like Penn and Morningside are popular despite "declining populations."</li>
                            <li><strong>Domino Effects:</strong> Changes to one school ripple through the entire network due to high mobility and interconnected choice patterns.</li>
                        </ul>

                        <p class="mt-3 mt-md-4 p-3 mb-0" style="background: rgba(251, 191, 36, 0.1); border-left: 4px solid var(--accent-yellow); border-radius: 4px; line-height: 1.6;">
                            <strong>Bottom Line:</strong> This complete mobility picture reveals that Area 5 operates as an interconnected system with substantial external inflows (from Other Boundaries and Out of District) and complex internal choice patterns. The diagram shows that student movement is highly dynamic - simple boundary-based projections miss the reality that hundreds of students cross boundaries daily, making enrollment predictions and consolidation plans far more uncertain than presented.
                        </p>
                    </div>

                    <!-- Enrollment vs Capacity Comparison -->
                    <div class="school-section" style="background: linear-gradient(135deg, #1a1f2e 0%, #252b3b 100%); border-left: 4px solid var(--accent-green);">
                        <h2 style="color: var(--accent-green);" id="enrollment-chart" class="mb-3">📊 Enrollment vs Capacity: All Area 5 Schools</h2>
                        <p class="text-secondary mb-3" style="line-height: 1.6;">
                            Current enrollment (bars) compared to building capacity ranges (diamond markers). This shows how each school's actual enrollment relates to its physical capacity.
                        </p>
                        <div class="chart-container">
                            <div id="capacityComparisonChart" class="w-100"></div>
                        </div>
                    </div>

                    <!-- Official PDF Links -->
                    <div class="alert alert-info" style="background: rgba(139, 92, 246, 0.1); border: 1px solid var(--accent-purple);">
                        <h3 class="mb-3" style="color: var(--accent-purple);">📄 Official Student Mobility Tables (October 1, 2025)</h3>
                        <p class="mb-3">All data in the diagram above comes from these official Granite School District PDF reports. Click to view the source documents:</p>
                        
                        <div class="row g-2 g-md-3">
                            <div class="col-12 col-sm-6 col-lg-4">
                                <a href="https://drive.google.com/file/d/1kZ45yNTPNsCj6UfGVB1IqqlN0ajo8NlP/view?usp=drive_link" target="_blank" class="pdf-link d-block text-center" style="margin: 0;">
                                    Cottonwood Elementary
                                </a>
                            </div>
                            <div class="col-12 col-sm-6 col-lg-4">
                                <a href="https://drive.google.com/file/d/1Q7GCy1ZDYClqa2VqvYCFeXuAWDdGJj5c/view?usp=drive_link" target="_blank" class="pdf-link d-block text-center" style="margin: 0;">
                                    Crestview Elementary
                                </a>
                            </div>
                            <div class="col-12 col-sm-6 col-lg-4">
                                <a href="https://drive.google.com/file/d/1pzhY45Wkdu0oci2DUdExV5XLhe8DvxzA/view?usp=drive_link" target="_blank" class="pdf-link d-block text-center" style="margin: 0;">
                                    Driggs Elementary
                                </a>
                            </div>
                            <div class="col-12 col-sm-6 col-lg-4">
                                <a href="https://drive.google.com/file/d/1g455zuX4Cf1anNWtY-xRGFBcRAA7AHix/view?usp=drive_link" target="_blank" class="pdf-link d-block text-center" style="margin: 0;">
                                    Eastwood Elementary
                                </a>
                            </div>
                            <div class="col-12 col-sm-6 col-lg-4">
                                <a href="https://drive.google.com/file/d/1ctraEm4HDC03uDpeV_Vf-VYbDI-7ipOA/view?usp=drive_link" target="_blank" class="pdf-link d-block text-center" style="margin: 0;">
                                    Morningside Elementary
                                </a>
                            </div>
                            <div class="col-12 col-sm-6 col-lg-4">
                                <a href="https://drive.google.com/file/d/1keB8MNJwtf4suOWRI5rZnQS6JNOE0TaT/view?usp=drive_link" target="_blank" class="pdf-link d-block text-center" style="margin: 0;">
                                    Oakridge Elementary
                                </a>
                            </div>
                            <div class="col-12 col-sm-6 col-lg-4">
                                <a href="https://drive.google.com/file/d/1P5GY919NNYb8VnbyF6q2fb_esl_Feosv/view?usp=drive_link" target="_blank" class="pdf-link d-block text-center" style="margin: 0;">
                                    Oakwood Elementary
                                </a>
                            </div>
                            <div class="col-12 col-sm-6 col-lg-4">
                                <a href="https://drive.google.com/file/d/1tslUABUeI5RvMEUtp5LsncDvdub2gJT9/view?usp=drive_link" target="_blank" class="pdf-link d-block text-center" style="margin: 0;">
                                    Penn Elementary
                                </a>
                            </div>
                            <div class="col-12 col-sm-6 col-lg-4">
                                <a href="https://drive.google.com/file/d/15ipdax53CJm7EbJjebmLUl5HzOQBODW0/view?usp=drive_link" target="_blank" class="pdf-link d-block text-center" style="margin: 0;">
                                    Rosecrest Elementary
                                </a>
                            </div>
                            <div class="col-12 col-sm-6 col-lg-4">
                                <a href="https://drive.google.com/file/d/156WpdphFi0YT-QXkT_Bi5_tQEjPQYVZv/view?usp=drive_link" target="_blank" class="pdf-link d-block text-center" style="margin: 0;">
                                    Upland Terrace Elementary
                                </a>
                            </div>
                        </div>
                        
                        <p style="margin-top: 1rem; color: var(--text-secondary); font-size: 0.9em;">
                            <em>Source: <a href="https://www.graniteschools.org/planning/student-mobility-and-population-tables/" target="_blank" style="color: var(--accent-cyan);">Granite School District - Student Mobility and Population Tables</a></em>
                        </p>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <footer class="mt-4 mt-md-5 py-4">
        <div class="container-fluid px-3">
            <p class="mb-2"><strong>Data Source:</strong> <a href="https://www.graniteschools.org/planning/student-mobility-and-population-tables/" target="_blank">Granite School District - Student Mobility and Population Tables</a></p>
            <p class="mb-2">All student mobility PDFs published October 1, 2025</p>
            <p class="small fst-italic mb-0">⚠️ This is an independent visualization of official Granite School District data. Not affiliated with GSD.</p>
        </div>
    </footer>

    <script>
        // School color scheme (matches main analysis)
        const schoolColors = {
            'Cottonwood': '#ef4444',
            'Crestview': '#f97316',
            'Driggs': '#fbbf24',
            'Eastwood': '#10b981',
            'Morningside': '#06b6d4',
            'Oakridge': '#8b5cf6',
            'Penn': '#ec4899',
            'Rosecrest': '#14b8a6',
            'Upland Terrace': '#84cc16',
            'Oakwood': '#6366f1'
        };

        // School data from official PDFs (October 1, 2025)
        const schools = [
            {
                name: 'Cottonwood',
                pdfLink: 'https://drive.google.com/file/d/1kZ45yNTPNsCj6UfGVB1IqqlN0ajo8NlP/view?usp=drive_link',
                totalEnrollment: 317,
                capacity: '500-550',
                utilization: '58%',
                boundaryStudents: '218 (69%)',
                outOfBoundary: '99 (31%)'
            },
            {
                name: 'Crestview',
                pdfLink: 'https://drive.google.com/file/d/1Q7GCy1ZDYClqa2VqvYCFeXuAWDdGJj5c/view?usp=drive_link',
                totalEnrollment: 463,
                capacity: '550-600',
                utilization: '80%',
                boundaryStudents: '424 (92%)',
                outOfBoundary: '39 (8%)'
            },
            {
                name: 'Driggs',
                pdfLink: 'https://drive.google.com/file/d/1pzhY45Wkdu0oci2DUdExV5XLhe8DvxzA/view?usp=drive_link',
                totalEnrollment: 462,
                capacity: '650-700',
                utilization: '68%',
                boundaryStudents: '340 (74%)',
                outOfBoundary: '122 (26%)'
            },
            {
                name: 'Eastwood',
                pdfLink: 'https://drive.google.com/file/d/1g455zuX4Cf1anNWtY-xRGFBcRAA7AHix/view?usp=drive_link',
                totalEnrollment: 233,
                capacity: '450-500',
                utilization: '49%',
                boundaryStudents: '124 (53%)',
                outOfBoundary: '109 (47%)',
                note: 'Recommended for closure'
            },
            {
                name: 'Morningside',
                pdfLink: 'https://drive.google.com/file/d/1ctraEm4HDC03uDpeV_Vf-VYbDI-7ipOA/view?usp=drive_link',
                totalEnrollment: 567,
                capacity: '600-650',
                utilization: '90%',
                boundaryStudents: '193 (34%)',
                outOfBoundary: '374 (66%)',
                note: 'Converting to DLI/ALC Magnet'
            },
            {
                name: 'Oakridge',
                pdfLink: 'https://drive.google.com/file/d/1keB8MNJwtf4suOWRI5rZnQS6JNOE0TaT/view?usp=drive_link',
                totalEnrollment: 242,
                capacity: '550-600',
                utilization: '42%',
                boundaryStudents: '168 (69%)',
                outOfBoundary: '74 (31%)',
                note: 'Receiving Eastwood students'
            },
            {
                name: 'Oakwood',
                pdfLink: 'https://drive.google.com/file/d/1P5GY919NNYb8VnbyF6q2fb_esl_Feosv/view?usp=drive_link',
                totalEnrollment: 518,
                capacity: '700-750',
                utilization: '72%',
                boundaryStudents: '333 (64%)',
                outOfBoundary: '185 (36%)'
            },
            {
                name: 'Penn',
                pdfLink: 'https://drive.google.com/file/d/1tslUABUeI5RvMEUtp5LsncDvdub2gJT9/view?usp=drive_link',
                totalEnrollment: 586,
                capacity: '600-650',
                utilization: '93%',
                boundaryStudents: '290 (49%)',
                outOfBoundary: '296 (51%)'
            },
            {
                name: 'Rosecrest',
                pdfLink: 'https://drive.google.com/file/d/15ipdax53CJm7EbJjebmLUl5HzOQBODW0/view?usp=drive_link',
                totalEnrollment: 286,
                capacity: '450-500',
                utilization: '60%',
                boundaryStudents: '227 (79%)',
                outOfBoundary: '59 (21%)'
            },
            {
                name: 'Upland Terrace',
                pdfLink: 'https://drive.google.com/file/d/156WpdphFi0YT-QXkT_Bi5_tQEjPQYVZv/view?usp=drive_link',
                totalEnrollment: 415,
                capacity: '650-700',
                utilization: '61%',
                boundaryStudents: '304 (73%)',
                outOfBoundary: '111 (27%)'
            }
        ];

        // Individual school sections removed - see comprehensive diagram above

        // Function to create Sankey diagrams
        function createSankeyDiagram(school, index) {
            // Sankey data for each school - showing where students live vs where they attend
            // Using data from Morningside CSV and estimates for others

            const sankeyData = getSankeyFlowData(school.name);

            if (!sankeyData) {
                document.getElementById(`sankey-${index}`).innerHTML =
                    '<p style="color: var(--text-secondary); padding: 2rem; text-align: center;">Detailed flow data available in the PDF above. Sankey diagram shows estimated patterns based on available enrollment data.</p>';
                return;
            }

            const data = [{
                type: 'sankey',
                orientation: 'h',
                node: {
                    pad: 15,
                    thickness: 20,
                    line: { color: '#374151', width: 0.5 },
                    label: sankeyData.labels,
                    color: sankeyData.colors
                },
                link: {
                    source: sankeyData.sources,
                    target: sankeyData.targets,
                    value: sankeyData.values,
                    color: sankeyData.linkColors
                }
            }];

            const layout = {
                font: { size: 12, color: '#e8eaed' },
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(0,0,0,0)',
                margin: { t: 20, b: 20, l: 20, r: 20 },
                height: 500
            };

            Plotly.newPlot(`sankey-${index}`, data, layout, { responsive: true });
        }

        // Get Sankey flow data for each school
        // ALL DATA FROM OFFICIAL DISTRICT PDFs (October 1, 2025)
        function getSankeyFlowData(schoolName) {
            const allSchoolFlowData = {
                'Morningside': {
                    // 567 total enrollment - Source: Morningside Pivot Tables.pdf (October 1, 2025)
                    // Values verified to sum to exactly 567 to match official enrollment
                    labels: [
                        'Morningside Boundary', 'Out of District', 'Upland Terrace', 'Driggs',
                        'Oakridge', 'Crestview', 'Rosecrest', 'Lincoln', 'Penn', 'Cottonwood',
                        'Wilson', 'Moss', 'Woodstock', 'Oakwood', 'Other Boundaries',
                        'Morningside Elementary'
                    ],
                    sources: [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14],
                    targets: [15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15],
                    values: [193, 68, 43, 39, 30, 29, 26, 23, 19, 19, 15, 15, 11, 11, 26],
                    linkColors: [
                        'rgba(6, 182, 212, 0.4)', 'rgba(156, 163, 175, 0.3)', 'rgba(132, 204, 22, 0.3)',
                        'rgba(251, 191, 36, 0.3)', 'rgba(139, 92, 246, 0.3)', 'rgba(249, 115, 22, 0.3)',
                        'rgba(20, 184, 166, 0.3)', 'rgba(99, 102, 241, 0.3)', 'rgba(236, 72, 153, 0.3)',
                        'rgba(239, 68, 68, 0.3)', 'rgba(100, 116, 139, 0.3)', 'rgba(147, 197, 253, 0.3)',
                        'rgba(134, 239, 172, 0.3)', 'rgba(99, 102, 241, 0.3)', 'rgba(156, 163, 175, 0.2)'
                    ],
                    colors: ['#06b6d4', '#9ca3af', '#84cc16', '#fbbf24', '#8b5cf6', '#f97316',
                             '#14b8a6', '#6366f1', '#ec4899', '#ef4444', '#64748b', '#93c5fd',
                             '#86efac', '#6366f1', '#9ca3af', '#06b6d4']
                },
                'Cottonwood': {
                    // 317 total enrollment - Source: Cottonwood Pivot Tables.pdf
                    labels: [
                        'Cottonwood Boundary', 'Oakwood', 'Out of District', 'Driggs',
                        'Moss', 'Other Boundaries', 'Cottonwood Elementary'
                    ],
                    sources: [0, 1, 2, 3, 4, 5],
                    targets: [6, 6, 6, 6, 6, 6],
                    values: [218, 43, 25, 10, 6, 15],
                    linkColors: [
                        'rgba(239, 68, 68, 0.4)', 'rgba(99, 102, 241, 0.3)', 'rgba(156, 163, 175, 0.3)',
                        'rgba(251, 191, 36, 0.3)', 'rgba(147, 197, 253, 0.3)', 'rgba(156, 163, 175, 0.2)'
                    ],
                    colors: ['#ef4444', '#6366f1', '#9ca3af', '#fbbf24', '#93c5fd', '#9ca3af', '#ef4444']
                },
                'Crestview': {
                    // 463 total enrollment - Source: Crestview Pivot Tables.pdf
                    labels: [
                        'Crestview Boundary', 'Penn', 'Out of District', 'Driggs',
                        'Lincoln', 'Moss', 'Other Boundaries', 'Crestview Elementary'
                    ],
                    sources: [0, 1, 2, 3, 4, 5, 6],
                    targets: [7, 7, 7, 7, 7, 7, 7],
                    values: [424, 11, 8, 6, 4, 3, 7],
                    linkColors: [
                        'rgba(249, 115, 22, 0.4)', 'rgba(236, 72, 153, 0.3)', 'rgba(156, 163, 175, 0.3)',
                        'rgba(251, 191, 36, 0.3)', 'rgba(99, 102, 241, 0.3)', 'rgba(147, 197, 253, 0.3)',
                        'rgba(156, 163, 175, 0.2)'
                    ],
                    colors: ['#f97316', '#ec4899', '#9ca3af', '#fbbf24', '#6366f1', '#93c5fd', '#9ca3af', '#f97316']
                },
                'Driggs': {
                    // 462 total enrollment - Source: Driggs Pivot Tables.pdf
                    labels: [
                        'Driggs Boundary', 'Morningside', 'Out of District', 'Moss',
                        'Crestview', 'Lincoln', 'Other Boundaries', 'Driggs Elementary'
                    ],
                    sources: [0, 1, 2, 3, 4, 5, 6],
                    targets: [7, 7, 7, 7, 7, 7, 7],
                    values: [340, 38, 16, 13, 9, 7, 39],
                    linkColors: [
                        'rgba(251, 191, 36, 0.4)', 'rgba(6, 182, 212, 0.3)', 'rgba(156, 163, 175, 0.3)',
                        'rgba(147, 197, 253, 0.3)', 'rgba(249, 115, 22, 0.3)', 'rgba(99, 102, 241, 0.3)',
                        'rgba(156, 163, 175, 0.2)'
                    ],
                    colors: ['#fbbf24', '#06b6d4', '#9ca3af', '#93c5fd', '#f97316', '#6366f1', '#9ca3af', '#fbbf24']
                },
                'Eastwood': {
                    // 233 total enrollment - Source: Eastwood Pivot Tables.pdf
                    labels: [
                        'Eastwood Boundary', 'Morningside', 'Out of District', 'Wilson',
                        'Lincoln', 'Rosecrest', 'Penn', 'Upland Terrace', 'Other Boundaries',
                        'Eastwood Elementary'
                    ],
                    sources: [0, 1, 2, 3, 4, 5, 6, 7, 8],
                    targets: [9, 9, 9, 9, 9, 9, 9, 9, 9],
                    values: [124, 19, 13, 13, 11, 10, 7, 7, 29],
                    linkColors: [
                        'rgba(16, 185, 129, 0.4)', 'rgba(6, 182, 212, 0.3)', 'rgba(156, 163, 175, 0.3)',
                        'rgba(100, 116, 139, 0.3)', 'rgba(99, 102, 241, 0.3)', 'rgba(20, 184, 166, 0.3)',
                        'rgba(236, 72, 153, 0.3)', 'rgba(132, 204, 22, 0.3)', 'rgba(156, 163, 175, 0.2)'
                    ],
                    colors: ['#10b981', '#06b6d4', '#9ca3af', '#64748b', '#6366f1', '#14b8a6',
                             '#ec4899', '#84cc16', '#9ca3af', '#10b981']
                },
                'Oakridge': {
                    // 242 total enrollment - Source: Oakridge Pivot Tables.pdf
                    labels: [
                        'Oakridge Boundary', 'Eastwood', 'Morningside', 'Out of District',
                        'Driggs', 'Olene Walker', 'Other Boundaries', 'Oakridge Elementary'
                    ],
                    sources: [0, 1, 2, 3, 4, 5, 6],
                    targets: [7, 7, 7, 7, 7, 7, 7],
                    values: [168, 23, 15, 12, 6, 6, 12],
                    linkColors: [
                        'rgba(139, 92, 246, 0.4)', 'rgba(16, 185, 129, 0.3)', 'rgba(6, 182, 212, 0.3)',
                        'rgba(156, 163, 175, 0.3)', 'rgba(251, 191, 36, 0.3)', 'rgba(190, 24, 93, 0.3)',
                        'rgba(156, 163, 175, 0.2)'
                    ],
                    colors: ['#8b5cf6', '#10b981', '#06b6d4', '#9ca3af', '#fbbf24', '#be185d', '#9ca3af', '#8b5cf6']
                },
                'Oakwood': {
                    // 518 total enrollment - Source: Oakwood Pivot Tables.pdf
                    labels: [
                        'Oakwood Boundary', 'Out of District', 'Woodstock', 'Moss',
                        'Crestview', 'Lincoln', 'Wilson', 'Other Boundaries', 'Oakwood Elementary'
                    ],
                    sources: [0, 1, 2, 3, 4, 5, 6, 7],
                    targets: [8, 8, 8, 8, 8, 8, 8, 8],
                    values: [333, 79, 30, 23, 10, 10, 9, 24],
                    linkColors: [
                        'rgba(99, 102, 241, 0.4)', 'rgba(156, 163, 175, 0.3)', 'rgba(134, 239, 172, 0.3)',
                        'rgba(147, 197, 253, 0.3)', 'rgba(249, 115, 22, 0.3)', 'rgba(99, 102, 241, 0.3)',
                        'rgba(100, 116, 139, 0.3)', 'rgba(156, 163, 175, 0.2)'
                    ],
                    colors: ['#6366f1', '#9ca3af', '#86efac', '#93c5fd', '#f97316', '#6366f1',
                             '#64748b', '#9ca3af', '#6366f1']
                },
                'Penn': {
                    // 586 total enrollment - Source: Penn Pivot Tables.pdf
                    labels: [
                        'Penn Boundary', 'Lincoln', 'Out of District', 'Moss',
                        'Rosecrest', 'Wilson', 'Crestview', 'Cottonwood', 'Upland Terrace',
                        'Oakwood', 'Other Boundaries', 'Penn Elementary'
                    ],
                    sources: [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10],
                    targets: [11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11],
                    values: [290, 62, 53, 46, 25, 20, 17, 10, 10, 10, 43],
                    linkColors: [
                        'rgba(236, 72, 153, 0.4)', 'rgba(99, 102, 241, 0.3)', 'rgba(156, 163, 175, 0.3)',
                        'rgba(147, 197, 253, 0.3)', 'rgba(20, 184, 166, 0.3)', 'rgba(100, 116, 139, 0.3)',
                        'rgba(249, 115, 22, 0.3)', 'rgba(239, 68, 68, 0.3)', 'rgba(132, 204, 22, 0.3)',
                        'rgba(99, 102, 241, 0.3)', 'rgba(156, 163, 175, 0.2)'
                    ],
                    colors: ['#ec4899', '#6366f1', '#9ca3af', '#93c5fd', '#14b8a6', '#64748b',
                             '#f97316', '#ef4444', '#84cc16', '#6366f1', '#9ca3af', '#ec4899']
                },
                'Rosecrest': {
                    // 286 total enrollment - Source: Rosecrest Pivot Tables.pdf
                    labels: [
                        'Rosecrest Boundary', 'Out of District', 'Lincoln', 'Penn',
                        'Wilson', 'Other Boundaries', 'Rosecrest Elementary'
                    ],
                    sources: [0, 1, 2, 3, 4, 5],
                    targets: [6, 6, 6, 6, 6, 6],
                    values: [227, 17, 10, 8, 8, 16],
                    linkColors: [
                        'rgba(20, 184, 166, 0.4)', 'rgba(156, 163, 175, 0.3)', 'rgba(99, 102, 241, 0.3)',
                        'rgba(236, 72, 153, 0.3)', 'rgba(100, 116, 139, 0.3)', 'rgba(156, 163, 175, 0.2)'
                    ],
                    colors: ['#14b8a6', '#9ca3af', '#6366f1', '#ec4899', '#64748b', '#9ca3af', '#14b8a6']
                },
                'Upland Terrace': {
                    // 415 total enrollment - Source: Upland Terrace Pivot Tables.pdf
                    labels: [
                        'Upland Terrace Boundary', 'Lincoln', 'Morningside', 'Out of District',
                        'Moss', 'Rosecrest', 'Crestview', 'Wilson', 'Woodstock', 'Penn',
                        'Other Boundaries', 'Upland Terrace Elementary'
                    ],
                    sources: [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10],
                    targets: [11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11],
                    values: [304, 17, 15, 9, 9, 9, 8, 7, 7, 7, 23],
                    linkColors: [
                        'rgba(132, 204, 22, 0.4)', 'rgba(99, 102, 241, 0.3)', 'rgba(6, 182, 212, 0.3)',
                        'rgba(156, 163, 175, 0.3)', 'rgba(147, 197, 253, 0.3)', 'rgba(20, 184, 166, 0.3)',
                        'rgba(249, 115, 22, 0.3)', 'rgba(100, 116, 139, 0.3)', 'rgba(134, 239, 172, 0.3)',
                        'rgba(236, 72, 153, 0.3)', 'rgba(156, 163, 175, 0.2)'
                    ],
                    colors: ['#84cc16', '#6366f1', '#06b6d4', '#9ca3af', '#93c5fd', '#14b8a6',
                             '#f97316', '#64748b', '#86efac', '#ec4899', '#9ca3af', '#84cc16']
                }
            };

            return allSchoolFlowData[schoolName] || null;
        }

        // Get boundary resident flow data for each school (where boundary residents actually attend)
        function getBoundaryFlowData(schoolName) {
            const boundaryFlows = {
                'Cottonwood': {
                    // 265 boundary residents - Source: Cottonwood Pivot Tables.pdf
                    total: 265,
                    labels: ['Cottonwood Boundary (265)', 'Cottonwood Elementary', 'Morningside',
                             'Penn', 'Driggs', 'Woodstock', 'Other Schools'],
                    sources: [0, 0, 0, 0, 0, 0],
                    targets: [1, 2, 3, 4, 5, 6],
                    values: [218, 19, 10, 5, 3, 10],
                    destinations: ['Cottonwood Elementary', 'Morningside', 'Penn', 'Driggs', 'Woodstock', 'Other Schools']
                },
                'Crestview': {
                    // 528 boundary residents - Source: Crestview Pivot Tables.pdf
                    total: 528,
                    labels: ['Crestview Boundary (528)', 'Crestview Elementary', 'Morningside',
                             'Penn', 'Alternative 3-A', 'Driggs', 'Oakwood', 'Upland Terrace', 'Woodstock', 'Other Schools'],
                    sources: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                    targets: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10],
                    values: [424, 29, 17, 10, 9, 10, 8, 8, 13],
                    destinations: ['Crestview Elementary', 'Morningside', 'Penn', 'Alternative 3-A', 'Driggs',
                                   'Oakwood', 'Upland Terrace', 'Woodstock', 'Other Schools']
                },
                'Driggs': {
                    // 432 boundary residents - Source: Driggs Pivot Tables.pdf
                    total: 432,
                    labels: ['Driggs Boundary (432)', 'Driggs Elementary', 'Morningside',
                             'Alternative 3-A', 'Cottonwood', 'Penn', 'Oakridge', 'Upland Terrace',
                             'Crestview', 'Other Schools'],
                    sources: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                    targets: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10],
                    values: [340, 39, 13, 10, 9, 6, 6, 6, 3],
                    destinations: ['Driggs Elementary', 'Morningside', 'Alternative 3-A', 'Cottonwood', 'Penn',
                                   'Oakridge', 'Upland Terrace', 'Crestview', 'Other Schools']
                },
                'Eastwood': {
                    // 162 boundary residents - Source: Eastwood Pivot Tables.pdf
                    total: 162,
                    labels: ['Eastwood Boundary (162)', 'Eastwood Elementary', 'Oakridge',
                             'Morningside', 'Upland Terrace', 'Other Schools'],
                    sources: [0, 0, 0, 0, 0, 0],
                    targets: [1, 2, 3, 4, 5, 6],
                    values: [124, 23, 6, 5, 4],
                    destinations: ['Eastwood Elementary', 'Oakridge', 'Morningside', 'Upland Terrace', 'Other Schools']
                },
                'Morningside': {
                    // 293 boundary residents - Source: Morningside Pivot Tables.pdf
                    total: 293,
                    labels: ['Morningside Boundary (293)', 'Morningside Elementary', 'Driggs',
                             'Eastwood', 'Upland Terrace', 'Oakridge', 'Alternative 3-A', 'Penn',
                             'Rosecrest', 'Cottonwood'],
                    sources: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                    targets: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10],
                    values: [193, 38, 19, 15, 15, 5, 4, 3, 1],
                    destinations: ['Morningside Elementary', 'Driggs', 'Eastwood', 'Upland Terrace', 'Oakridge',
                                   'Alternative 3-A', 'Penn', 'Rosecrest', 'Cottonwood']
                },
                'Oakridge': {
                    // 214 boundary residents - Source: Oakridge Pivot Tables.pdf
                    total: 214,
                    labels: ['Oakridge Boundary (214)', 'Oakridge Elementary', 'Morningside',
                             'Eastwood', 'Alternative 3-A', 'Upland Terrace', 'Cottonwood', 'Other Schools'],
                    sources: [0, 0, 0, 0, 0, 0, 0, 0],
                    targets: [1, 2, 3, 4, 5, 6, 7, 8],
                    values: [168, 30, 4, 3, 2, 2, 5],
                    destinations: ['Oakridge Elementary', 'Morningside', 'Eastwood', 'Alternative 3-A',
                                   'Upland Terrace', 'Cottonwood', 'Other Schools']
                },
                'Oakwood': {
                    // 472 boundary residents - Source: Oakwood Pivot Tables.pdf
                    total: 472,
                    labels: ['Oakwood Boundary (472)', 'Oakwood Elementary', 'Cottonwood',
                             'Woodstock', 'Alternative 3-A', 'Morningside', 'Penn', 'Upland Terrace',
                             'Driggs', 'Other Schools'],
                    sources: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                    targets: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10],
                    values: [333, 43, 42, 11, 11, 10, 5, 7, 10],
                    destinations: ['Oakwood Elementary', 'Cottonwood', 'Woodstock', 'Alternative 3-A', 'Morningside',
                                   'Penn', 'Upland Terrace', 'Driggs', 'Other Schools']
                },
                'Penn': {
                    // 359 boundary residents - Source: Penn Pivot Tables.pdf
                    total: 359,
                    labels: ['Penn Boundary (359)', 'Penn Elementary', 'Morningside', 'Rosecrest',
                             'Crestview', 'Upland Terrace', 'Eastwood', 'Driggs', 'Other Schools'],
                    sources: [0, 0, 0, 0, 0, 0, 0, 0, 0],
                    targets: [1, 2, 3, 4, 5, 6, 7, 8, 9],
                    values: [290, 19, 8, 11, 7, 7, 6, 11],
                    destinations: ['Penn Elementary', 'Morningside', 'Rosecrest', 'Crestview', 'Upland Terrace',
                                   'Eastwood', 'Driggs', 'Other Schools']
                },
                'Rosecrest': {
                    // 316 boundary residents - Source: Rosecrest Pivot Tables.pdf
                    total: 316,
                    labels: ['Rosecrest Boundary (316)', 'Rosecrest Elementary', 'Penn',
                             'Morningside', 'Upland Terrace', 'Eastwood', 'Alternative 3-A', 'Other Schools'],
                    sources: [0, 0, 0, 0, 0, 0, 0, 0],
                    targets: [1, 2, 3, 4, 5, 6, 7, 8],
                    values: [227, 25, 26, 9, 10, 8, 11],
                    destinations: ['Rosecrest Elementary', 'Penn', 'Morningside', 'Upland Terrace', 'Eastwood',
                                   'Alternative 3-A', 'Other Schools']
                },
                'Upland Terrace': {
                    // 382 boundary residents - Source: Upland Terrace Pivot Tables.pdf
                    total: 382,
                    labels: ['Upland Terrace Boundary (382)', 'Upland Terrace Elementary', 'Morningside',
                             'Penn', 'Eastwood', 'Alternative 3-A', 'Other Schools'],
                    sources: [0, 0, 0, 0, 0, 0, 0],
                    targets: [1, 2, 3, 4, 5, 6, 7],
                    values: [304, 43, 10, 7, 4, 14],
                    destinations: ['Upland Terrace Elementary', 'Morningside', 'Penn', 'Eastwood', 'Alternative 3-A', 'Other Schools']
                }
            };

            return boundaryFlows[schoolName] || null;
        }

        // Create boundary residents flow diagram for all schools
        function createBoundaryResidentsSankey(school, index) {
            const flowData = getBoundaryFlowData(school.name);
            if (!flowData) return;

            // Build color arrays
            const schoolColor = schoolColors[school.name];
            const colors = [schoolColor]; // First color is the boundary

            // Add colors for destination schools
            flowData.destinations.forEach(dest => {
                const destSchoolName = dest.replace(' Elementary', '');
                colors.push(schoolColors[destSchoolName] || schoolColor);
            });

            // Build link colors - primary destination gets stronger color
            const linkColors = flowData.values.map((val, idx) => {
                if (idx === 0) {
                    // Staying at home school - strong color
                    return schoolColor.replace('rgb', 'rgba').replace(')', ', 0.5)');
                } else {
                    // Going elsewhere - lighter color
                    const destColor = colors[idx + 1];
                    return destColor.replace('#', 'rgba(').replace(/(..)(..)(..)/,
                        (m, r, g, b) => `${parseInt(r,16)}, ${parseInt(g,16)}, ${parseInt(b,16)}, 0.3)`);
                }
            });

            const data = [{
                type: 'sankey',
                orientation: 'h',
                node: {
                    pad: 15,
                    thickness: 20,
                    line: { color: '#374151', width: 0.5 },
                    label: flowData.labels,
                    color: colors
                },
                link: {
                    source: flowData.sources,
                    target: flowData.targets,
                    value: flowData.values,
                    color: linkColors
                }
            }];

            const layout = {
                font: { size: 12, color: '#e8eaed' },
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(0,0,0,0)',
                margin: { t: 20, b: 20, l: 20, r: 20 },
                height: 400
            };

            Plotly.newPlot(`sankey-boundary-${index}`, data, layout, { responsive: true });
        }

        // Store comprehensive Sankey data globally
        let comprehensiveSankeyData = {
            schoolNames: [],
            sources: [],
            targets: [],
            rawValues: [], // Original student counts
            linkColors: [],
            labels: [],
            nodeColors: [],
            boundaryTotals: [] // Total students in each boundary
        };

        // Create comprehensive Sankey diagram with ALL sources and destinations
        function createComprehensiveSankey() {
            const area5Schools = ['Cottonwood', 'Crestview', 'Driggs', 'Eastwood', 'Morningside', 
                                'Oakridge', 'Oakwood', 'Penn', 'Rosecrest', 'Upland Terrace'];
            
            // Collect all unique sources and destinations from the data
            const allSources = new Set();
            const allDestinations = new Set();
            const flowMap = {}; // key: "source->destination", value: count
            const sourceTotals = {}; // For percentage calculation
            
            // PART 1: Collect data from boundary flows (where boundary residents go)
            area5Schools.forEach(sourceName => {
                const flowData = getBoundaryFlowData(sourceName);
                if (!flowData) return;
                
                const sourceLabel = `${sourceName} Boundary`;
                allSources.add(sourceLabel);
                sourceTotals[sourceLabel] = flowData.total;
                
                flowData.destinations.forEach((dest, idx) => {
                    let destLabel = dest;
                    
                    // Consolidate non-Area 5 schools into "Other Schools"
                    const destWithoutElementary = destLabel.replace(' Elementary', '');
                    if (area5Schools.includes(destWithoutElementary)) {
                        // Area 5 school - keep as is with Elementary
                        destLabel = `${destWithoutElementary} Elementary`;
                    } else if (destLabel === 'Other Schools' || destLabel === 'Alternative 3-A' || 
                               destLabel === 'Woodstock Elementary' || destLabel === 'Woodstock' ||
                               ['Lincoln', 'Wilson', 'Moss', 'Olene Walker'].includes(destWithoutElementary)) {
                        // Consolidate all non-Area 5 destinations
                        destLabel = 'Other Schools';
                    }
                    
                    allDestinations.add(destLabel);
                    const key = `${sourceLabel}->${destLabel}`;
                    flowMap[key] = (flowMap[key] || 0) + flowData.values[idx];
                });
            });
            
            // PART 2: Collect data from inflow to schools (where students come from)
            // Only add flows NOT already captured from boundary data (to avoid double-counting)
            area5Schools.forEach(schoolName => {
                const inflowData = getSankeyFlowData(schoolName);
                if (!inflowData) return;
                
                const destLabel = `${schoolName} Elementary`;
                allDestinations.add(destLabel);
                
                // Process each source in the inflow data
                inflowData.sources.forEach((srcIdx, flowIdx) => {
                    let sourceLabel = inflowData.labels[srcIdx];
                    const targetIdx = inflowData.targets[flowIdx];
                    let targetLabel = inflowData.labels[targetIdx];
                    
                    // Consolidate non-Area 5 boundaries into "Other Boundaries"
                    const sourceLabelClean = sourceLabel.replace(' Boundary', '');
                    if (area5Schools.includes(sourceLabelClean)) {
                        // Area 5 boundary - already captured in PART 1, skip to avoid duplication
                        return;
                    } else if (sourceLabel === 'Out of District') {
                        // Keep "Out of District" separate
                        sourceLabel = 'Out of District';
                    } else if (sourceLabel === 'Other Boundaries' || 
                               ['Lincoln', 'Wilson', 'Moss', 'Woodstock', 'Olene Walker'].includes(sourceLabelClean)) {
                        // Consolidate all other GSD boundaries
                        sourceLabel = 'Other Boundaries';
                    }
                    
                    // Only count if target is this Area 5 school
                    targetLabel = `${schoolName} Elementary`;
                    
                    allSources.add(sourceLabel);
                    const key = `${sourceLabel}->${destLabel}`;
                    
                    // Add flow (these are non-Area 5 sources not in boundary data)
                    flowMap[key] = (flowMap[key] || 0) + inflowData.values[flowIdx];
                });
            });
            
            // Calculate totals ONLY for sources not already set (Other Boundaries, Out of District)
            // Do NOT recalculate Area 5 boundary totals - they're already set from boundary data
            Object.keys(flowMap).forEach(key => {
                const [source, dest] = key.split('->');
                // Only calculate if not already set (i.e., not an Area 5 boundary)
                if (sourceTotals[source] === undefined) {
                    sourceTotals[source] = 0;
                }
            });
            
            // Now sum flows for sources that need calculation (non-Area 5 boundaries)
            Object.keys(flowMap).forEach(key => {
                const [source, dest] = key.split('->');
                const sourceName = source.replace(' Boundary', '');
                // Only sum if this is NOT an Area 5 boundary (those already have correct totals)
                if (!area5Schools.includes(sourceName)) {
                    sourceTotals[source] += flowMap[key];
                }
            });
            
            // Create ordered labels: sources on left, destinations on right
            const sourceLabels = Array.from(allSources).sort((a, b) => {
                // Area 5 boundaries first, then others
                const aIsArea5 = area5Schools.some(s => a === `${s} Boundary`);
                const bIsArea5 = area5Schools.some(s => b === `${s} Boundary`);
                if (aIsArea5 && !bIsArea5) return -1;
                if (!aIsArea5 && bIsArea5) return 1;
                return a.localeCompare(b);
            });
            
            const destLabels = Array.from(allDestinations).sort((a, b) => {
                // Area 5 schools first, then others
                const aIsArea5 = area5Schools.some(s => a === `${s} Elementary`);
                const bIsArea5 = area5Schools.some(s => b === `${s} Elementary`);
                if (aIsArea5 && !bIsArea5) return -1;
                if (!aIsArea5 && bIsArea5) return 1;
                return a.localeCompare(b);
            });
            
            const labels = [...sourceLabels, ...destLabels];
            const sourceOffset = 0;
            const destOffset = sourceLabels.length;
            
            // Build flows
            const sources = [];
            const targets = [];
            const rawValues = [];
            const linkColors = [];
            
            Object.keys(flowMap).forEach(key => {
                const [source, dest] = key.split('->');
                const sourceIdx = sourceLabels.indexOf(source);
                const destIdx = destLabels.indexOf(dest);
                
                if (sourceIdx !== -1 && destIdx !== -1) {
                    sources.push(sourceIdx);
                    targets.push(destIdx + destOffset);
                    rawValues.push(flowMap[key]);
                    
                    // Determine color based on source
                    let color;
                    const sourceBoundaryName = source.replace(' Boundary', '');
                    const destSchoolName = dest.replace(' Elementary', '');
                    
                    if (schoolColors[sourceBoundaryName]) {
                        // Area 5 boundary - use school color
                        const sourceColor = schoolColors[sourceBoundaryName];
                        if (sourceBoundaryName === destSchoolName) {
                            // Same school - strong color
                            color = sourceColor.replace('rgb', 'rgba').replace(')', ', 0.6)') || 
                                   sourceColor.replace('#', 'rgba(').replace(/(..)(..)(..)/,
                                       (m, r, g, b) => `${parseInt(r,16)}, ${parseInt(g,16)}, ${parseInt(b,16)}, 0.6)`);
                        } else {
                            // Different school - lighter
                            color = sourceColor.replace('rgb', 'rgba').replace(')', ', 0.25)') || 
                                   sourceColor.replace('#', 'rgba(').replace(/(..)(..)(..)/,
                                       (m, r, g, b) => `${parseInt(r,16)}, ${parseInt(g,16)}, ${parseInt(b,16)}, 0.25)`);
                        }
                    } else {
                        // Non-Area 5 source - gray
                        color = 'rgba(156, 163, 175, 0.25)';
                    }
                    
                    linkColors.push(color);
                }
            });
            
            // Build node colors
            const nodeColors = labels.map(label => {
                const schoolName = label.replace(' Boundary', '').replace(' Elementary', '');
                return schoolColors[schoolName] || '#9ca3af';
            });
            
            // Store data globally
            comprehensiveSankeyData = {
                sourceLabels,
                destLabels,
                sources,
                targets,
                rawValues,
                linkColors,
                labels,
                nodeColors,
                sourceTotals
            };
            
            // Display values in student counts
            const displayValues = [...rawValues];
            
            // Calculate percentage of source total for each flow
            const percentages = rawValues.map((val, idx) => {
                const sourceIdx = sources[idx];
                const sourceLabel = sourceLabels[sourceIdx];
                const sourceTotal = sourceTotals[sourceLabel] || 1;
                return sourceTotal > 0 ? (val / sourceTotal * 100) : 0;
            });
            
            // Hover template for student counts with percentage
            const hoverTemplate = '%{source.label} → %{target.label}<br><b>%{value} students</b><br>(%{customdata:.1f}% of %{source.label} total)<extra></extra>';
            
            const data = [{
                type: 'sankey',
                orientation: 'h',
                node: {
                    pad: window.innerWidth < 768 ? 12 : 20,
                    thickness: window.innerWidth < 768 ? 18 : 25,
                    line: { color: '#374151', width: window.innerWidth < 768 ? 0.5 : 1 },
                    label: labels,
                    color: nodeColors,
                    hovertemplate: '%{label}<br>%{value} students<extra></extra>'
                },
                link: {
                    source: sources,
                    target: targets,
                    value: displayValues,
                    color: linkColors,
                    customdata: percentages,
                    hovertemplate: hoverTemplate
                }
            }];
            
            const layout = {
                font: { size: window.innerWidth < 768 ? 8 : 10, color: '#e8eaed' },
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(0,0,0,0)',
                margin: { 
                    t: 30, 
                    b: 30, 
                    l: window.innerWidth < 768 ? 5 : 10, 
                    r: window.innerWidth < 768 ? 5 : 10 
                },
                height: window.innerWidth < 768 ? 
                    Math.max(600, labels.length * 20) : 
                    Math.max(900, labels.length * 25)
            };
            
            Plotly.newPlot('comprehensiveSankeyChart', data, layout, { responsive: true, displayModeBar: window.innerWidth >= 768 });
        }
        
        // Create the comprehensive sankey
        createComprehensiveSankey();
        
        // Calculate enrollment totals from Sankey flow data (right side of diagram)
        const area5Schools = ['Cottonwood', 'Crestview', 'Driggs', 'Eastwood', 'Morningside', 
                            'Oakridge', 'Oakwood', 'Penn', 'Rosecrest', 'Upland Terrace'];
        
        const sankeyEnrollments = {};
        area5Schools.forEach(schoolName => {
            const destLabel = `${schoolName} Elementary`;
            // Sum all flows going to this school
            let total = 0;
            Object.keys(comprehensiveSankeyData.sourceLabels).forEach((_, srcIdx) => {
                comprehensiveSankeyData.sources.forEach((source, flowIdx) => {
                    if (source === srcIdx) {
                        const target = comprehensiveSankeyData.targets[flowIdx];
                        const targetLabel = comprehensiveSankeyData.labels[target];
                        if (targetLabel === destLabel) {
                            total += comprehensiveSankeyData.rawValues[flowIdx];
                        }
                    }
                });
            });
            sankeyEnrollments[schoolName] = total;
        });
        
        // Display total enrollment from Sankey
        const totalArea5Enrollment = Object.values(sankeyEnrollments).reduce((sum, val) => sum + val, 0);
        document.getElementById('totalEnrollmentDisplay').textContent = totalArea5Enrollment.toLocaleString();

        // Create enrollment vs capacity comparison chart using Sankey-calculated enrollments
        const enrollmentTrace = {
            x: schools.map(s => s.name),
            y: schools.map(s => sankeyEnrollments[s.name] || s.totalEnrollment),
            name: 'Current Enrollment (from Sankey)',
            type: 'bar',
            marker: { 
                color: schools.map(s => schoolColors[s.name]),
                line: { color: 'rgba(255, 255, 255, 0.2)', width: 1 }
            },
            text: schools.map(s => sankeyEnrollments[s.name] || s.totalEnrollment),
            textposition: 'outside',
            textfont: { size: 11, color: '#e8eaed' }
        };

        const minCapacityTrace = {
            x: schools.map(s => s.name),
            y: schools.map(s => parseInt(s.capacity.split('-')[0])),
            name: 'Min Capacity',
            type: 'scatter',
            mode: 'markers+text',
            marker: { 
                color: '#10b981', 
                size: 14, 
                symbol: 'diamond',
                line: { color: '#065f46', width: 2 }
            },
            text: schools.map(s => s.capacity.split('-')[0]),
            textposition: 'top center',
            textfont: { size: 10, color: '#10b981' }
        };

        const maxCapacityTrace = {
            x: schools.map(s => s.name),
            y: schools.map(s => parseInt(s.capacity.split('-')[1])),
            name: 'Max Capacity',
            type: 'scatter',
            mode: 'markers+text',
            marker: { 
                color: '#ef4444', 
                size: 14, 
                symbol: 'diamond',
                line: { color: '#991b1b', width: 2 }
            },
            text: schools.map(s => s.capacity.split('-')[1]),
            textposition: 'top center',
            textfont: { size: 10, color: '#ef4444' }
        };

        const capacityLayout = {
            paper_bgcolor: 'rgba(0,0,0,0)',
            plot_bgcolor: 'rgba(0,0,0,0)',
            font: { color: '#e8eaed', size: window.innerWidth < 768 ? 10 : 12 },
            xaxis: {
                color: '#9ca3af',
                gridcolor: '#374151',
                tickangle: window.innerWidth < 576 ? -60 : -45,
                tickfont: { size: window.innerWidth < 576 ? 9 : 11 }
            },
            yaxis: {
                title: { 
                    text: window.innerWidth < 576 ? 'Students' : 'Number of Students', 
                    font: { size: window.innerWidth < 768 ? 12 : 14 } 
                },
                color: '#9ca3af',
                gridcolor: '#374151'
            },
            legend: {
                orientation: window.innerWidth < 768 ? 'h' : 'v',
                x: window.innerWidth < 768 ? 0 : 1.02,
                y: window.innerWidth < 768 ? -0.35 : 1,
                font: { size: window.innerWidth < 576 ? 10 : 12 },
                bgcolor: 'rgba(26, 31, 46, 0.8)',
                bordercolor: '#374151',
                borderwidth: 1
            },
            margin: { 
                b: window.innerWidth < 576 ? 120 : 140, 
                t: window.innerWidth < 576 ? 40 : 60, 
                l: window.innerWidth < 576 ? 60 : 80, 
                r: window.innerWidth < 768 ? 20 : 120 
            },
            hovermode: 'closest',
            height: window.innerWidth < 576 ? 400 : undefined
        };

        Plotly.newPlot('capacityComparisonChart', [enrollmentTrace, minCapacityTrace, maxCapacityTrace], capacityLayout, { 
            responsive: true, 
            displayModeBar: window.innerWidth >= 768 
        });

        // Handle window resize for responsive updates
        let resizeTimeout;
        window.addEventListener('resize', function() {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(function() {
                createComprehensiveSankey();
                Plotly.newPlot('capacityComparisonChart', [enrollmentTrace, minCapacityTrace, maxCapacityTrace], {
                    ...capacityLayout,
                    font: { color: '#e8eaed', size: window.innerWidth < 768 ? 10 : 12 },
                    xaxis: {
                        ...capacityLayout.xaxis,
                        tickangle: window.innerWidth < 576 ? -60 : -45,
                        tickfont: { size: window.innerWidth < 576 ? 9 : 11 }
                    },
                    yaxis: {
                        ...capacityLayout.yaxis,
                        title: { 
                            text: window.innerWidth < 576 ? 'Students' : 'Number of Students', 
                            font: { size: window.innerWidth < 768 ? 12 : 14 } 
                        }
                    },
                    legend: {
                        ...capacityLayout.legend,
                        orientation: window.innerWidth < 768 ? 'h' : 'v',
                        x: window.innerWidth < 768 ? 0 : 1.02,
                        y: window.innerWidth < 768 ? -0.35 : 1,
                        font: { size: window.innerWidth < 576 ? 10 : 12 }
                    },
                    margin: { 
                        b: window.innerWidth < 576 ? 120 : 140, 
                        t: window.innerWidth < 576 ? 40 : 60, 
                        l: window.innerWidth < 576 ? 60 : 80, 
                        r: window.innerWidth < 768 ? 20 : 120 
                    },
                    height: window.innerWidth < 576 ? 400 : undefined
                }, { responsive: true, displayModeBar: window.innerWidth >= 768 });
            }, 250);
        });
    </script>

    <!-- Navigation Toggle Script -->
    <script>
        const navToggle = document.getElementById('navToggle');
        const navSidebar = document.getElementById('navSidebar');
        const navOverlay = document.getElementById('navOverlay');

        function toggleNav() {
            navToggle.classList.toggle('active');
            navSidebar.classList.toggle('active');
            navOverlay.classList.toggle('active');
        }

        navToggle.addEventListener('click', toggleNav);
        navOverlay.addEventListener('click', toggleNav);

        // Close nav when clicking a link
        const navLinks = navSidebar.querySelectorAll('a');
        navLinks.forEach(link => {
            link.addEventListener('click', () => {
                if (link.getAttribute('href').startsWith('#')) {
                    toggleNav();
                }
            });
        });

        // Close nav on escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && navSidebar.classList.contains('active')) {
                toggleNav();
            }
        });
    </script>
</body>
</html>
